#!/bin/bash

## La Popa Ã©s Nuestra !
## Script developed for atorresbr (( atorresbr@gmail.com ))

# This function sends an error message to user if they don't use sudo
if [ "$(whoami)" != "root" ]
then
  echo
    echo -e " ðŸ”´ use the sudo command to run this script "
    sleep 1
    echo
    echo -e " ðŸ”´ use el comando sudo para usar el script "
    sleep 1
    echo
    echo -e " ðŸ”´ use o comando sudo para rodar o script de instalaÃ§Ã£o "
  echo
  exit 1
fi

# Set error handling to prevent unexpected exits
set -e
trap 'echo "Error occurred at line $LINENO. Command: $BASH_COMMAND"; exit 1' ERR

echo
echo

# Define color codes
on_yellow='\033[43m'  # Yellow
on_green='\033[42m'   # Green
b_yellow='\033[1;33m' # Bold Yellow
b_black='\033[1;30m'  # Boldblack
b_green='\033[1;32m'  # Bold Green
green='\033[0;32m'    # Light Green
red='\033[0;31m'      # Red
nc='\033[0m'          # No Color

sleep 2

clear

echo -ne ${b_green}

echo -e "
   * * * =============================================== * * * 
 *        ðŸ‡ªðŸ‡¸   Executando los Comandos de Shell                *
   * * * =============================================== * * *
"
sleep 2
clear

echo -e "
   * * * =============================================== * * * 
 *        ðŸ‡§ðŸ‡·   Executando os Comandos de Shell                 *
   * * * =============================================== * * *
"

sleep 2
clear

echo -e "
   * * * =============================================== * * * 
 *        ðŸ‡ºðŸ‡¸     Executing the Shell commmands                 *
   * * * =============================================== * * *
"

echo -e "
                                                                   __ 
 _____ _____ _____ _____    _____ _____ _____ ____  _____ _____   |  |
|   __|     |  _  |  _  |  |   __|  _  |  _  |    \|   __|   __|  |  |
|__   |  |  |   __|     |  |__   |   __|     |  |  |   __|__   |  |__|
|_____|_____|__|  |__|__|  |_____|__|  |__|__|____/|_____|_____|  |__|
                                                                      
"

echo
echo

## Providing installation information

echo -ne ${b_green}

sleep 2
echo -e "
   * * * =============================================== * * * 
 *       ðŸ‡ªðŸ‡¸ Este script instalarÃ¡ Sopa Spades en tu PC ðŸœ      *
   * * * =============================================== * * *
"
sleep 2
echo -e "
   * * * =============================================== * * * 
 *     ðŸ‡ºðŸ‡¸ This script will install Sopa Spades on your PC ðŸœ   *
   * * * =============================================== * * *
"

sleep 2
echo -e "
   * * * =============================================== * * * 
 *   ðŸ‡§ðŸ‡· Este script irÃ¡ instalar o Sopa Spades em seu PC ðŸœ    *
   * * * =============================================== * * *
"

echo
echo

# Clean up any previous build or installation
echo
sleep 2
echo -e " ðŸ‡ªðŸ‡¸ Eliminando el directorio antiguo para reinstalar el juego âœ…"

echo
sleep 2
echo -e " ðŸ‡ºðŸ‡¸ Removing the old directory to reinstall the Game âœ…"

echo 
sleep 2
echo -e " ðŸ‡§ðŸ‡· Removendo o antigo diretÃ³rio para reinstalar o Jogo âœ… "

echo
echo 

echo -ne ${b_yellow}

sleep 2
echo -e " sudo rm -rf /usr/local/share/games/openspades "

sleep 2

echo
echo -e " && "
echo

sleep 2
echo -e " sudo rm -rf /usr/local/share/games/sopaspades "

echo -ne ${nc}

echo

sleep 1
echo -ne ${b_green}'ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©    (33%)\r '
sleep 1
echo -ne 'ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©    (66%)\r '
sleep 1
echo -ne 'ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©    (100%)\r ' ${nc}
echo -ne '\n'
sleep 2

echo -ne ${b_yellow}

echo
echo -e " ÃŠxito !"
echo

echo -ne ${nc}

sleep 2

# Clean up old installations (with error handling)
rm -rf /usr/local/games/openspades 2>/dev/null || true
rm -rf /usr/local/games/sopaspades 2>/dev/null || true
rm -rf /usr/local/share/games/openspades 2>/dev/null || true
rm -rf /usr/local/share/games/sopaspades 2>/dev/null || true
rm -rf /usr/share/applications/openspades.desktop 2>/dev/null || true
rm -rf /usr/share/applications/sopaspades.desktop 2>/dev/null || true
rm -rf /usr/share/pixmaps/openspades.xpm 2>/dev/null || true
rm -rf /usr/share/pixmaps/sopaspades.xpm 2>/dev/null || true
rm -rf /usr/games/openspades 2>/dev/null || true
rm -rf /usr/games/sopaspades 2>/dev/null || true
apt purge openspades -y || true

echo
echo

echo -e " it's not a error ðŸ™Œ ðŸ‘† "

echo
echo

# Install dependencies
echo
sleep 2

echo -ne ${b_green}

echo -e " ðŸ‡ªðŸ‡¸ Instalando las dependencias "

echo
sleep 2

echo -e " ðŸ‡ºðŸ‡¸ Installing the dependencies "

echo
sleep 2

echo -e " ðŸ‡§ðŸ‡· Instalando as dependÃªncias "

echo
echo

sleep 1

echo -ne ${b_green}

echo " sudo apt-get install "

echo -ne ${b_yellow}

   echo
   echo    " ðŸº pkg-config libglew-dev "
sleep 1
   echo
   echo    " ðŸº libcurl3-openssl-dev " 
sleep 1
   echo
   echo    " ðŸº libsdl2-dev "
sleep 1
   echo
   echo    " ðŸº libsdl2-image-dev "
sleep 1
   echo
   echo    " ðŸ˜‹ libalut-dev "
sleep 1
   echo
   echo    " ðŸº xdg-utils libfreetype6-dev "
sleep 1
   echo
   echo    " ðŸº libopus-dev "
sleep 1
   echo
   echo    " ðŸº libopusfile-dev "
sleep 1
   echo
   echo    " ðŸº cmake imagemagick "
sleep 1
   echo
   echo    " ðŸº libjpeg-dev "
sleep 1
   echo
   echo    " ðŸ˜‹ ðŸ™ libxinerama-dev "
sleep 1
   echo
   echo    " ðŸ™ libxft-dev "
sleep 1

echo
echo

sleep 1
echo -ne ${b_green}'ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©    (33%)\r '
sleep 1
echo -ne 'ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©    (66%)\r '
sleep 1
echo -ne 'ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©    (100%)\r '
echo -ne '\n'
sleep 2

echo -ne ${b_yellow}

echo
echo -e " ÃŠxito !"
echo

sleep 1

# Install dependencies (with error handling)
echo -ne ${b_yellow}

# Try using apt-get, but if it fails, try with apt
(apt-get install -y pkg-config libglew-dev libcurl3-openssl-dev libsdl2-dev \
  libsdl2-image-dev libalut-dev xdg-utils libfreetype6-dev libopus-dev \
  libopusfile-dev cmake imagemagick \
  libjpeg-dev libxinerama-dev libxft-dev) || \
(apt install -y pkg-config libglew-dev libcurl3-openssl-dev libsdl2-dev \
  libsdl2-image-dev libalut-dev xdg-utils libfreetype6-dev libopus-dev \
  libopusfile-dev cmake imagemagick \
  libjpeg-dev libxinerama-dev libxft-dev)

echo
echo

echo -ne ${b_green}

# Clone repository
sleep 2
echo -e " ðŸ‡ªðŸ‡¸ Clonando el repositorio y instalando "

echo
sleep 2

echo -e " ðŸ‡ºðŸ‡¸ Cloning the repository and installing "

echo
sleep 2

echo -e " ðŸ‡§ðŸ‡· Clonando o repositÃ³rio e instalando "

echo
sleep 2

echo -ne ${b_yellow}

echo -e " sudo rm -Rf sopaspades && sudo rm -Rf openspades "
sleep 1

echo
echo -e " && "
echo

sleep 1
echo -e " git clone https://github.com/atorresbr/sopaspades.git && cd sopaspades "

echo
echo

sleep 1
echo -ne ${b_green}'ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©    (33%)\r '
sleep 1
echo -ne 'ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©    (66%)\r '
sleep 1
echo -ne 'ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©    (100%)\r ' ${nc}
echo -ne '\n'
sleep 2

echo -ne ${b_yellow}

echo
echo -e " ÃŠxito !"
echo

sleep 2

# Get username for home directory path
USERNAME=$(logname || echo $SUDO_USER || whoami)
USER_HOME=$(eval echo ~$USERNAME)

# Clean up old directories and clone repository
rm -rf "$USER_HOME/sopaspades" 2>/dev/null || true
rm -rf "$USER_HOME/openspades" 2>/dev/null || true

# Clone to user's home directory
cd "$USER_HOME" || { echo "Could not navigate to home directory"; exit 1; }
git clone https://github.com/atorresbr/sopaspades.git || { echo "Failed to clone repository"; exit 1; }
cd sopaspades || { echo "Failed to enter sopaspades directory"; exit 1; }

echo
echo   

sleep 2

echo -ne ${b_green}

echo -e " ðŸ‡ªðŸ‡¸ instalando"

echo
sleep 2

echo -e " ðŸ‡ºðŸ‡¸ installing"

echo
sleep 2

echo -e " ðŸ‡§ðŸ‡· instalando"

echo
sleep 2

echo -ne ${b_yellow}

echo -e " mkdir sopaspades.mk && cd sopaspades.mk && "
sleep 1
echo -e " cmake .. -DCMAKE_BUILD_TYPE=RelWithDebInfo && "
sleep 1
echo -e " make -j$(nproc) && sudo make install "
sleep 1

echo
echo

sleep 1
echo -ne ${b_green}'ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©    (33%)\r '
sleep 1
echo -ne 'ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©    (66%)\r '
sleep 1
echo -ne 'ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©ðŸŸ©    (100%)\r ' ${nc}
echo -ne '\n'
sleep 2

echo -ne ${b_yellow}

echo
echo -e " ÃŠxito !"
echo

sleep 1

# Create build directory and build SopaSpades
mkdir -p sopaspades.mk || { echo "Failed to create build directory"; exit 1; }
cd sopaspades.mk || { echo "Failed to enter build directory"; exit 1; }
cmake .. -DCMAKE_BUILD_TYPE=RelWithDebInfo || { echo "CMake configuration failed"; exit 1; }

# Use all available CPU cores for faster build
CORES=$(nproc 2>/dev/null || echo 2)
echo "Building with $CORES CPU cores"
make -j${CORES} || { echo "Make build failed"; exit 1; }
make install || { echo "Make install failed"; exit 1; }

# Ensure correct permissions for user resources
mkdir -p "$USER_HOME/.local/share/sopaspades/Resources" 2>/dev/null || true
chown -R $USERNAME:$USERNAME "$USER_HOME/.local/share/sopaspades" 2>/dev/null || true

# Clean up build files to save disk space
cd ..
# Uncomment if you want to remove build files after installation
# rm -rf sopaspades.mk
   
echo
echo

echo -ne ${b_green}

sleep 1

echo -e " ðŸ‡ªðŸ‡¸ comenzando el Juego "

echo
sleep 1
echo -e " ðŸ‡ºðŸ‡¸ starting the Game "

echo
sleep 1
echo -e " ðŸ‡§ðŸ‡· iniciando o Jogo "

echo
sleep 1

echo
echo

echo -e " ðŸ˜˜ ðŸ‡ªðŸ‡¸ Comparte este script ! "

echo
sleep 1

echo -e " ðŸ˜˜ ðŸ‡ºðŸ‡¸ Share this Script ! "

echo
sleep 1

echo -e " ðŸ˜˜ ðŸ‡§ðŸ‡· Compartilhe este Script ! "

echo

echo
echo

# Make sure sopaspades is executable and in PATH
chmod +x /usr/games/sopaspades 2>/dev/null || true
chmod +x /usr/local/games/sopaspades 2>/dev/null || true

# Start the game using the correct command
echo " sopaspades ðŸ”« "
# Check if we can run it directly
if command -v sopaspades >/dev/null 2>&1; then
  sopaspades
elif [ -x "/usr/games/sopaspades" ]; then
  /usr/games/sopaspades
elif [ -x "/usr/local/games/sopaspades" ]; then
  /usr/local/games/sopaspades
else
  echo "SopaSpades executable not found in PATH. Please run it manually."
fi

echo
echo